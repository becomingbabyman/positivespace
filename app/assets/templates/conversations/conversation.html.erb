<div class="row-fluid conversation {{animateCss}} {{conversation.relationship}}" ng-class="{expanded: expanded}" ui-if="!hideAll">
	<div class="span12 uncenter pbl ptm">
		<div class="row-fluid">
			<div class="span2">
				<a href="#" ng-click='toggleExpand()'>
					<img ng-src="{{conversation.from.avatar.thumb_url}}" alt="{{conversation.from.name}}" class="img-rounded img-border" ui-if='conversation.partners_id == conversation.from.id'>
					<img ng-src="{{conversation.to.avatar.thumb_url}}" alt="{{conversation.to.name}}" class="img-rounded img-border" ui-if='conversation.partners_id == conversation.to.id'>
				</a>
			</div>
			<div class="span10">
				<div class="row-fluid">
					<div class="span12">
						<small class='faded pull-right'>
							<time datetime="{{conversation.updated_at}}">
								{{conversation.updated_at | fromNow}}
							</time>
						</small>
						<a href="#" ng-click='toggleExpand()' class='unfancy-link'>
							<h4 class='pull-left m0' ui-if='conversation.from.id == conversation.partners_id'>{{conversation.from.name}}</h4>
							<h4 class='pull-left m0' ui-if='conversation.to.id == conversation.partners_id'>{{conversation.to.name}}</h4>
						</a>
					</div>
				</div>
				<div class="row-fluid">
					<div class="span12 font12 faded">
						<a href="/{{conversation.to.slug}}" class='faded'>{{conversation.to.name}}</a>
						prompted:
					</div>
				</div>
				<div class="row-fluid">
					<div class="span12">
						<a href="#" ng-click='toggleExpand()' class='unfancy-link'>
							<div class='prompt' ng-bind-html-unsafe="conversation.prompt | linebreaks">{{conversation.prompt}}</div>
						</a>
					</div>
				</div>
			</div>
		</div>

		<div class="row-fluid" ui-if='expanded'>
			<div class="span12">

				<img ng-src="<%= asset_path 'loading.gif' %>" alt="loading" ng-hide='messages.collection.length > 0'>
				<div class="row-fluid" ng-repeat="msg in messages.collection">
					<div class="span12 message pbs ptl">
						<div class="row-fluid">
							<div class="span12 uncenter">
								<small class='pull-right faded'>
									<time datetime="{{msg.created_at}}">
										{{msg.created_at | date:'MMM d'}}
									</time>
								</small>
								<a ng-href="/{{msg.from.slug}}" title='{{msg.from.name}}' class='faded'>
									<img ng-src="{{msg.from.avatar.thumb_url}}" alt="{{msg.from.name}}" class="img-rounded img-border img-mini">
									<small class='from-name'>{{msg.from.name}}</small>
								</a>
							</div>
						</div>

						<div class="row-fluid">
							<div class="span12 uncenter">
								<p class='body' ng-bind-html-unsafe="msg.body | linebreaks">{{msg.body}}</p>
							</div>
						</div>

						<div class="row-fluid" ui-if='msg.embed_url'>
							<div class="span12">
								<img ui-if='(msg.embed_data.thumbnail_url || msg.embed_data.type == "photo") && !msg.embed_data.html' alt='{{msg.embed_data.title}}' title='{{msg.embed_data.title}}' ng-src='{{msg.embed_data.thumbnail_url || msg.embed_data.url}}'>
								<div ng-bind-html-unsafe="msg.embed_data.html"></div>
								<a ng-href='{{msg.embed_url}}' target='_blank' title='{{msg.embed_data.description}}' class='font12'>{{msg.embed_url}}</a>
							</div>
						</div>
					</div>
				</div>

				<div ui-if='conversation.relationship == "ready"' class="row-fluid reply">
					<div class="span12 pbl">
						<!-- <a href="#" class="reply pull-right">reply</a> -->

						<form name='replyForm' class='reply' ng-submit="save('send')" novalidate style='width: 100%;'>
							<control-group maxlength='{{conversation.max_char_count}}'>
								<textarea name='body' cols="30" rows="2" ng-model='myMessage.body' id='response_body' placeholder='your response' class='input-block-level' required></textarea>
							</control-group>

							<div ui-if='show.embedInput'>
								<control-group>
									<input type="url" name='embed_url' id='my_message_embed_url' title='embed url' placeholder='http://example.com' class='input-block-level' ng-model='myMessage.embed_url' ng-disabled='myMessage.id'>
								</control-group>
							</div>

							<div class='control-group'>
								<div class='controls'>
									<button type='submit' class='btn btn-success pull-right' ng-disabled="replyForm.body.$invalid" ps-loading='sendingMsg'>
										Send
									</button>

									<span class='pull-right pts'>&nbsp;&nbsp;or&nbsp;&nbsp;</span>

									<a href='#' class='pull-right' ng-click='end()' tooltip="End the conversation if it's going nowhere." tooltip-placement='left'>
										<i class="icon-remove-circle font30 color-red opacity8"></i>
									</a>

									<a href='#' class='muted pts pull-left' ng-click='show.embedInput = true' ng-hide='show.embedInput' tooltip='Attach a link. We will magically find and embed picture, video, audio, and more in your response.' tooltip-placement='right'><i class='icon-paper-clip font20'></i> Attach 1 link</a>
									<a href='#' class='muted pts pull-left' ng-click='show.embedInput = false' ui-if='show.embedInput'><i class='icon-unlink font20'></i></a>
								</div>
							</div>
						</form>

					</div>
				</div>


				<div ui-if='conversation.relationship == "waiting"' class="row-fluid ptm">
					<div class="span12 well well-small center">
						Awaiting reply.
					</div>
				</div>


				<div ui-if='conversation.relationship == "ended"' class="row-fluid ptm">
					<div class="span12">

						<div class="row-fluid">
							<div class="span12 well center mbm" tooltip='This conversation has ended. If you have more to say you may start a new one.' tooltip-placement='bottom'>
								The end.
							</div>
						</div>

						<div class="row-fluid" ui-if="myReview.id">
							<div class="span12">
								<h5 ui-if="myReview.vote != null">
									You said this was
									<span ui-if="myReview.vote">a <span class="color-primary font18">positive</span></span>
									<span ui-if="!myReview.vote"><span class="color-danger font20">not</span> a positive</span>
									conversation.
								</h5>
								<h5 ui-if="myReview.rating">
									And liked it
									<rating value="myReview.rating" max="10" readonly="true"></rating>
									much
								</h5>
								<p ui-if="myReview.explanation">
									Saying: {{myReview.explanation}}
								</p>
							</div>
						</div>

						<div class="row-fluid" ui-if="myReview.vote == null">
							<div class="span12">
								<h4>Was this a positive conversation for you?</h4>
								<a href="#" class="btn btn-large btn-primary" ng-click="saveReview({vote: true})" ps-loading='reviewing && myReview.vote'>Positive</a>
								&nbsp;
								<span class="pts">or</span>
								&nbsp;
								<a href="#" class="btn btn-large btn-danger" ng-click="saveReview({vote: false})" ps-loading='reviewing && !myReview.vote'>Not</a>
								<br/>
								<br/>
								<small>Your response is private.</small>
								<br/>
								<small>It is used to improve conversation quality.</small>
							</div>
						</div>

						<div class="row-fluid" ui-if="myReview.vote != null && !myReview.rating">
							<div class="span12">
								<h4>How much would you like to have another conversation like this?</h4>
								<rating value="myReview.rating" max="10"></rating>
							</div>
						</div>

						<div class="row-fluid" ui-if="myReview.vote != null && myReview.rating && !myReview.explanation">
							<div class="span12">
								<h4>Why <span ui-if='myReview.vote'>was</span><span ui-if='!myReview.vote'>wasn't</span> it positive?</h4>
								<textarea name="explanation" ng-model="tmpExplanation" placeholder="Write a brief explanation..." class='input-block-level' rows="3"></textarea>
								<small>We may share this anonmously.</small>
								<a href="#" class="btn btn-success pull-right" ng-click="saveReview({explanation: tmpExplanation})" ps-loading="reviewing">Submit</a>
							</div>
						</div>

					</div>
				</div>


			</div>
		</div>

		<div class="row-fluid" ng-hide="messages.collection.length > 0">
			<div class="span12">
				<a href="#" ng-click='toggleExpand()' class='unfancy-link'>
					<p class='message muted font14' ng-bind-html-unsafe="conversation.last_message_body | linebreaks">{{conversation.last_message_body}}</p>
				</a>
			</div>
		</div>

	</div>
</div>

####################################################
# <ps-space>
ps.directive "psSpace", ["$location", "User", "Message", ($location, User, Message) ->
	restrict: "E"
	templateUrl: "<%= asset_path('directives/ps_space.html') %>"
	replace: true
	scope:
		app: '='
		user: '='
		callback: '='

	link: (scope, element, attrs) ->
		scope.message = new Message
		scope.hasFocus = false
		scope.autosave = { body: "msg_to_space_#{scope.user.space.id}" }

		scope.setFocus = (bool) ->
			if bool
				scope.hasFocus = true
			else if !scope.message.body? or scope.message.body.length < 1
				scope.hasFocus = false

		scope.endorse = ->
			if window.confirm("\nPlease note. This action cannot be undone. \n\nEndorsing this space will make it discoverable to the Positive Space community! And this space will forever link to yours. Do you want to endorse #{scope.user.name}?")
				if scope.app.loggedIn()
					scope.user.state = 'endorsed'
					scope.user.invitation = {user: scope.app.currentUser}
					User.update
						id: scope.app.currentUser.id
						endorse_user: scope.user.id
					, (user) ->
						scope.app.flash 'success', "Awesome, #{scope.user.name} is now officially part of the Positive Space community. #{scope.user.first_name} will be notified and #{window.possessive(scope.user.first_name)} space is now linked to your space."
						analytics.track "endorse space success",
							href: window.location.href
							userId: scope.user.id
							userName: scope.user.name
							userPrompt: scope.user.space?.prompt
							currentId: scope.app.currentUser.id
							currentName: scope.app.currentUser.name
					, (error) ->
						scope.user.state = 'unendorsed'
						scope.user.invitation = null
						scope.app.flash 'error', error.data.errors
						analytics.track "endorse space error",
							href: window.location.href
							userId: scope.user.id
							userName: scope.user.name
							userPrompt: scope.user.space?.prompt
							currentId: scope.app.currentUser.id
							currentName: scope.app.currentUser.name
							error: JSON.stringify(error)
				else
					scope.app.flash 'info', "Log in to endorse #{window.possessive(scope.user.first_name)} space"
					$location.search('path', "/#{scope.user.slug}")
					$location.path('/login')

		scope.social = (action) ->
			has = "has_#{action.replace(/^un/, '')}"
			if scope.app.loggedIn()
				unless scope.user.id == scope.app.currentUser.id
					scope.user[has] = !scope.user[has]
					User.update
						id: scope.app.currentUser.id
						socialable_type: 'User'
						socialable_id: scope.user.id
						socialable_action: action
					, (user) ->
						analytics.track "#{action} space success",
							href: window.location.href
							userId: scope.user.id
							userName: scope.user.name
							userPrompt: scope.user.space?.prompt
							currentId: scope.app.currentUser.id
							currentName: scope.app.currentUser.name
					, (error) ->
						scope.user[has] = !scope.user[has]
						scope.app.flash 'error', error.data.errors
						analytics.track "#{action} space error",
							href: window.location.href
							userId: scope.user.id
							userName: scope.user.name
							userPrompt: scope.user.space?.prompt
							currentId: scope.app.currentUser.id
							currentName: scope.app.currentUser.name
							error: JSON.stringify(error)
				else
					scope.app.flash 'notice', "Sorry, you cannot #{action} yourself"
			else
				scope.app.flash 'info', "Log in to #{action} #{window.possessive(scope.user.first_name)} space"
				$location.search('path', "/#{scope.user.slug}")
				$location.path('/login')

		scope.submitMessage = ->
			if scope.app.loggedIn()
				scope.app.show.loading = true
				success = (data) ->
					scope.app.show.loading = false
					amplify.store(scope.autosave.body, null)
					# scope.app.flash 'success', 'Great, your message has been sent.'
					analytics.track 'message space success',
						href: window.location.href
						userId: scope.user.id
						userName: scope.user.name
						userPrompt: scope.user.space?.prompt
						fromId: scope.app.currentUser.id
						fromName: scope.app.currentUser.name
						hasEmbedUrl: scope.message.embed_url?
					if scope.callback?
						scope.callback(data)
				error = (error) ->
					scope.app.show.loading = false
					scope.app.flash 'error', error.data.errors
					analytics.track 'message space error',
						href: window.location.href
						userId: scope.user.id
						userName: scope.user.name
						userPrompt: scope.user.space?.prompt
						fromId: scope.app.currentUser.id
						fromName: scope.app.currentUser.name
						hasEmbedUrl: scope.message.embed_url?
						error: JSON.stringify(error)
				scope.message.user_id = scope.user.id
				scope.message.state_event = 'send'
				scope.message.save success, error
			else
				# TODO: popup login modal with prompt
				# See copy on iPad drafts app
				scope.app.flash 'info', "Log in to talk with #{scope.user.name}. Your message has been temporarily saved and you can send it after you log in."
				$location.search('path', "/#{scope.user.slug}")
				$location.path('/login')
				analytics.track 'message space error',
					href: window.location.href
					userId: scope.user.id
					userName: scope.user.name
					userPrompt: scope.user.space?.prompt
					error: 'not logged in'
]

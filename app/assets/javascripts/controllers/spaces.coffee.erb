root = global ? window


ps.controller "SpacesEmbedLinkCtrl", ["$scope", "$routeParams", "space", ($scope, $routeParams, space) ->
	$scope.space = space
	$scope.text = $routeParams.text
	$scope.eid = $routeParams.eid
	# $scope.app.meta.title = "" # TODO: Write a title

	$scope.clickEmbed = ->
		window.parent.postMessage("psClickLink_#{$scope.eid}", "*")
]

ps.controller "SpacesEmbedExpandedCtrl", ["$scope", "$routeParams", "space", ($scope, $routeParams, space) ->
	$scope.space = space
	$scope.user = space.user
	$scope.eid = $routeParams.eid
	# $scope.app.meta.title = "" # TODO: Write a title

	$scope.clickEmbed = ->
		window.parent.postMessage("psCloseExpandedLink_#{$scope.eid}", "*")
]

root.resolves.spacesEmbed =
	space: ["$q", "$route", "Space", ($q, $route, Space) ->
		defered = $q.defer()
		query = {id: $route.current.params.id}
		Space.get query, (space) ->
			defered.resolve(space)
			analytics.track 'view embedded space success'
		, (error) ->
			defered.resolve({})
			analytics.track 'view embedded space error'
		defered.promise
	]
	userSpace: ["$q", "$route", "User", ($q, $route, User) ->
		defered = $q.defer()
		query = {id: $route.current.params.id}
		User.get query, (user) ->
			# TODO: UNHACK: this is a bit silly
			space = user.space
			space.user = user
			defered.resolve(space)
			analytics.track 'view embedded space success'
		, (error) ->
			defered.resolve({})
			analytics.track 'view embedded space error'
		defered.promise
	]
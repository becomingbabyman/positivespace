# TODO:
	# Make the link text in the iframe selectable

## Get jQuery
((root, window, document, version, callback) ->
	j = undefined
	d = undefined
	loaded = false
	if not (j = window.jQuery) or version > j.fn.jquery or callback(root, j, loaded)
		script = document.createElement("script")
		script.type = "text/javascript"
		script.src = "https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"
		script.onload = script.onreadystatechange = ->
			if not loaded and (not (d = @readyState) or d is "loaded" or d is "complete")
				callback root, (j = window.jQuery).noConflict(1), loaded = true
				j(script).remove()

		(document.getElementsByTagName("head")[0] or document.documentElement).appendChild script
) (global ? window), window, document, "1.8", (root, $, jquery_loaded) ->

	## Widget code
	root.positivespaceWidgetGlobalNamespace = (() ->
		ps = {}

		## Constants
		# TODO: find a better way to get the domain
		ps.DOMAIN = "<%= Rails.env == 'development' ? 'localhost:3000' : 'positivespace.io' %>"
		ps.embededLinks = {}
		ps.expandedLinks = {}
		ps.currentLinkId = null

		## Helpers
		jQuery = $
		# jQuery UI with Position and Clip components -- 24KB
		`
		/*! jQuery UI - v1.10.3 - 2013-09-12
		* http://jqueryui.com
		* Includes: jquery.ui.core.js, jquery.ui.position.js, jquery.ui.effect.js, jquery.ui.effect-clip.js
		* Copyright 2013 jQuery Foundation and other contributors; Licensed MIT */

		(function(t,e){function n(e,n){var r,s,o,a=e.nodeName.toLowerCase();return"area"===a?(r=e.parentNode,s=r.name,e.href&&s&&"map"===r.nodeName.toLowerCase()?(o=t("img[usemap=#"+s+"]")[0],!!o&&i(o)):!1):(/input|select|textarea|button|object/.test(a)?!e.disabled:"a"===a?e.href||n:n)&&i(e)}function i(e){return t.expr.filters.visible(e)&&!t(e).parents().addBack().filter(function(){return"hidden"===t.css(this,"visibility")}).length}var r=0,s=/^ui-id-\d+$/;t.ui=t.ui||{},t.extend(t.ui,{version:"1.10.3",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}),t.fn.extend({focus:function(e){return function(n,i){return"number"==typeof n?this.each(function(){var e=this;setTimeout(function(){t(e).focus(),i&&i.call(e)},n)}):e.apply(this,arguments)}}(t.fn.focus),scrollParent:function(){var e;return e=t.ui.ie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))?this.parents().filter(function(){return/(relative|absolute|fixed)/.test(t.css(this,"position"))&&/(auto|scroll)/.test(t.css(this,"overflow")+t.css(this,"overflow-y")+t.css(this,"overflow-x"))}).eq(0):this.parents().filter(function(){return/(auto|scroll)/.test(t.css(this,"overflow")+t.css(this,"overflow-y")+t.css(this,"overflow-x"))}).eq(0),/fixed/.test(this.css("position"))||!e.length?t(document):e},zIndex:function(n){if(n!==e)return this.css("zIndex",n);if(this.length)for(var i,r,s=t(this[0]);s.length&&s[0]!==document;){if(i=s.css("position"),("absolute"===i||"relative"===i||"fixed"===i)&&(r=parseInt(s.css("zIndex"),10),!isNaN(r)&&0!==r))return r;s=s.parent()}return 0},uniqueId:function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++r)})},removeUniqueId:function(){return this.each(function(){s.test(this.id)&&t(this).removeAttr("id")})}}),t.extend(t.expr[":"],{data:t.expr.createPseudo?t.expr.createPseudo(function(e){return function(n){return!!t.data(n,e)}}):function(e,n,i){return!!t.data(e,i[3])},focusable:function(e){return n(e,!isNaN(t.attr(e,"tabindex")))},tabbable:function(e){var i=t.attr(e,"tabindex"),r=isNaN(i);return(r||i>=0)&&n(e,!r)}}),t("<a>").outerWidth(1).jquery||t.each(["Width","Height"],function(n,i){function r(e,n,i,r){return t.each(s,function(){n-=parseFloat(t.css(e,"padding"+this))||0,i&&(n-=parseFloat(t.css(e,"border"+this+"Width"))||0),r&&(n-=parseFloat(t.css(e,"margin"+this))||0)}),n}var s="Width"===i?["Left","Right"]:["Top","Bottom"],o=i.toLowerCase(),a={innerWidth:t.fn.innerWidth,innerHeight:t.fn.innerHeight,outerWidth:t.fn.outerWidth,outerHeight:t.fn.outerHeight};t.fn["inner"+i]=function(n){return n===e?a["inner"+i].call(this):this.each(function(){t(this).css(o,r(this,n)+"px")})},t.fn["outer"+i]=function(e,n){return"number"!=typeof e?a["outer"+i].call(this,e):this.each(function(){t(this).css(o,r(this,e,!0,n)+"px")})}}),t.fn.addBack||(t.fn.addBack=function(t){return this.add(null==t?this.prevObject:this.prevObject.filter(t))}),t("<a>").data("a-b","a").removeData("a-b").data("a-b")&&(t.fn.removeData=function(e){return function(n){return arguments.length?e.call(this,t.camelCase(n)):e.call(this)}}(t.fn.removeData)),t.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase()),t.support.selectstart="onselectstart"in document.createElement("div"),t.fn.extend({disableSelection:function(){return this.bind((t.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(t){t.preventDefault()})},enableSelection:function(){return this.unbind(".ui-disableSelection")}}),t.extend(t.ui,{plugin:{add:function(e,n,i){var r,s=t.ui[e].prototype;for(r in i)s.plugins[r]=s.plugins[r]||[],s.plugins[r].push([n,i[r]])},call:function(t,e,n){var i,r=t.plugins[e];if(r&&t.element[0].parentNode&&11!==t.element[0].parentNode.nodeType)for(i=0;r.length>i;i++)t.options[r[i][0]]&&r[i][1].apply(t.element,n)}},hasScroll:function(e,n){if("hidden"===t(e).css("overflow"))return!1;var i=n&&"left"===n?"scrollLeft":"scrollTop",r=!1;return e[i]>0?!0:(e[i]=1,r=e[i]>0,e[i]=0,r)}})})(jQuery);(function(e,t){function a(e,t,a){return[parseFloat(e[0])*(m.test(e[0])?t/100:1),parseFloat(e[1])*(m.test(e[1])?a/100:1)]}function i(t,a){return parseInt(e.css(t,a),10)||0}function r(t){var a=t[0];return 9===a.nodeType?{width:t.width(),height:t.height(),offset:{top:0,left:0}}:e.isWindow(a)?{width:t.width(),height:t.height(),offset:{top:t.scrollTop(),left:t.scrollLeft()}}:a.preventDefault?{width:0,height:0,offset:{top:a.pageY,left:a.pageX}}:{width:t.outerWidth(),height:t.outerHeight(),offset:t.offset()}}e.ui=e.ui||{};var s,n=Math.max,o=Math.abs,d=Math.round,u=/left|center|right/,l=/top|center|bottom/,h=/[\+\-]\d+(\.[\d]+)?%?/,c=/^\w+/,m=/%$/,p=e.fn.position;e.position={scrollbarWidth:function(){if(s!==t)return s;var a,i,r=e("<div style='display:block;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>"),n=r.children()[0];return e("body").append(r),a=n.offsetWidth,r.css("overflow","scroll"),i=n.offsetWidth,a===i&&(i=r[0].clientWidth),r.remove(),s=a-i},getScrollInfo:function(t){var a=t.isWindow?"":t.element.css("overflow-x"),i=t.isWindow?"":t.element.css("overflow-y"),r="scroll"===a||"auto"===a&&t.width<t.element[0].scrollWidth,s="scroll"===i||"auto"===i&&t.height<t.element[0].scrollHeight;return{width:s?e.position.scrollbarWidth():0,height:r?e.position.scrollbarWidth():0}},getWithinInfo:function(t){var a=e(t||window),i=e.isWindow(a[0]);return{element:a,isWindow:i,offset:a.offset()||{left:0,top:0},scrollLeft:a.scrollLeft(),scrollTop:a.scrollTop(),width:i?a.width():a.outerWidth(),height:i?a.height():a.outerHeight()}}},e.fn.position=function(t){if(!t||!t.of)return p.apply(this,arguments);t=e.extend({},t);var s,m,f,g,y,k,x=e(t.of),T=e.position.getWithinInfo(t.within),b=e.position.getScrollInfo(T),S=(t.collision||"flip").split(" "),N={};return k=r(x),x[0].preventDefault&&(t.at="left top"),m=k.width,f=k.height,g=k.offset,y=e.extend({},g),e.each(["my","at"],function(){var e,a,i=(t[this]||"").split(" ");1===i.length&&(i=u.test(i[0])?i.concat(["center"]):l.test(i[0])?["center"].concat(i):["center","center"]),i[0]=u.test(i[0])?i[0]:"center",i[1]=l.test(i[1])?i[1]:"center",e=h.exec(i[0]),a=h.exec(i[1]),N[this]=[e?e[0]:0,a?a[0]:0],t[this]=[c.exec(i[0])[0],c.exec(i[1])[0]]}),1===S.length&&(S[1]=S[0]),"right"===t.at[0]?y.left+=m:"center"===t.at[0]&&(y.left+=m/2),"bottom"===t.at[1]?y.top+=f:"center"===t.at[1]&&(y.top+=f/2),s=a(N.at,m,f),y.left+=s[0],y.top+=s[1],this.each(function(){var r,u,l=e(this),h=l.outerWidth(),c=l.outerHeight(),p=i(this,"marginLeft"),k=i(this,"marginTop"),v=h+p+i(this,"marginRight")+b.width,M=c+k+i(this,"marginBottom")+b.height,D=e.extend({},y),_=a(N.my,l.outerWidth(),l.outerHeight());"right"===t.my[0]?D.left-=h:"center"===t.my[0]&&(D.left-=h/2),"bottom"===t.my[1]?D.top-=c:"center"===t.my[1]&&(D.top-=c/2),D.left+=_[0],D.top+=_[1],e.support.offsetFractions||(D.left=d(D.left),D.top=d(D.top)),r={marginLeft:p,marginTop:k},e.each(["left","top"],function(a,i){e.ui.position[S[a]]&&e.ui.position[S[a]][i](D,{targetWidth:m,targetHeight:f,elemWidth:h,elemHeight:c,collisionPosition:r,collisionWidth:v,collisionHeight:M,offset:[s[0]+_[0],s[1]+_[1]],my:t.my,at:t.at,within:T,elem:l})}),t.using&&(u=function(e){var a=g.left-D.left,i=a+m-h,r=g.top-D.top,s=r+f-c,d={target:{element:x,left:g.left,top:g.top,width:m,height:f},element:{element:l,left:D.left,top:D.top,width:h,height:c},horizontal:0>i?"left":a>0?"right":"center",vertical:0>s?"top":r>0?"bottom":"middle"};h>m&&m>o(a+i)&&(d.horizontal="center"),c>f&&f>o(r+s)&&(d.vertical="middle"),d.important=n(o(a),o(i))>n(o(r),o(s))?"horizontal":"vertical",t.using.call(this,e,d)}),l.offset(e.extend(D,{using:u}))})},e.ui.position={fit:{left:function(e,t){var a,i=t.within,r=i.isWindow?i.scrollLeft:i.offset.left,s=i.width,o=e.left-t.collisionPosition.marginLeft,d=r-o,u=o+t.collisionWidth-s-r;t.collisionWidth>s?d>0&&0>=u?(a=e.left+d+t.collisionWidth-s-r,e.left+=d-a):e.left=u>0&&0>=d?r:d>u?r+s-t.collisionWidth:r:d>0?e.left+=d:u>0?e.left-=u:e.left=n(e.left-o,e.left)},top:function(e,t){var a,i=t.within,r=i.isWindow?i.scrollTop:i.offset.top,s=t.within.height,o=e.top-t.collisionPosition.marginTop,d=r-o,u=o+t.collisionHeight-s-r;t.collisionHeight>s?d>0&&0>=u?(a=e.top+d+t.collisionHeight-s-r,e.top+=d-a):e.top=u>0&&0>=d?r:d>u?r+s-t.collisionHeight:r:d>0?e.top+=d:u>0?e.top-=u:e.top=n(e.top-o,e.top)}},flip:{left:function(e,t){var a,i,r=t.within,s=r.offset.left+r.scrollLeft,n=r.width,d=r.isWindow?r.scrollLeft:r.offset.left,u=e.left-t.collisionPosition.marginLeft,l=u-d,h=u+t.collisionWidth-n-d,c="left"===t.my[0]?-t.elemWidth:"right"===t.my[0]?t.elemWidth:0,m="left"===t.at[0]?t.targetWidth:"right"===t.at[0]?-t.targetWidth:0,p=-2*t.offset[0];0>l?(a=e.left+c+m+p+t.collisionWidth-n-s,(0>a||o(l)>a)&&(e.left+=c+m+p)):h>0&&(i=e.left-t.collisionPosition.marginLeft+c+m+p-d,(i>0||h>o(i))&&(e.left+=c+m+p))},top:function(e,t){var a,i,r=t.within,s=r.offset.top+r.scrollTop,n=r.height,d=r.isWindow?r.scrollTop:r.offset.top,u=e.top-t.collisionPosition.marginTop,l=u-d,h=u+t.collisionHeight-n-d,c="top"===t.my[1],m=c?-t.elemHeight:"bottom"===t.my[1]?t.elemHeight:0,p="top"===t.at[1]?t.targetHeight:"bottom"===t.at[1]?-t.targetHeight:0,f=-2*t.offset[1];0>l?(i=e.top+m+p+f+t.collisionHeight-n-s,e.top+m+p+f>l&&(0>i||o(l)>i)&&(e.top+=m+p+f)):h>0&&(a=e.top-t.collisionPosition.marginTop+m+p+f-d,e.top+m+p+f>h&&(a>0||h>o(a))&&(e.top+=m+p+f))}},flipfit:{left:function(){e.ui.position.flip.left.apply(this,arguments),e.ui.position.fit.left.apply(this,arguments)},top:function(){e.ui.position.flip.top.apply(this,arguments),e.ui.position.fit.top.apply(this,arguments)}}},function(){var t,a,i,r,s,n=document.getElementsByTagName("body")[0],o=document.createElement("div");t=document.createElement(n?"div":"body"),i={visibility:"hidden",width:0,height:0,border:0,margin:0,background:"none"},n&&e.extend(i,{position:"absolute",left:"-1000px",top:"-1000px"});for(s in i)t.style[s]=i[s];t.appendChild(o),a=n||document.documentElement,a.insertBefore(t,a.firstChild),o.style.cssText="position: absolute; left: 10.7432222px;",r=e(o).offset().left,e.support.offsetFractions=r>10&&11>r,t.innerHTML="",a.removeChild(t)}()})(jQuery);(function(e,t){var i="ui-effects-";e.effects={effect:{}},function(e,t){function i(e,t,i){var a=l[t.type]||{};return null==e?i||!t.def?null:t.def:(e=a.floor?~~e:parseFloat(e),isNaN(e)?t.def:a.mod?(e+a.mod)%a.mod:0>e?0:e>a.max?a.max:e)}function a(i){var a=u(),r=a._rgba=[];return i=i.toLowerCase(),p(d,function(e,s){var n,o=s.re.exec(i),d=o&&s.parse(o),u=s.space||"rgba";return d?(n=a[u](d),a[h[u].cache]=n[h[u].cache],r=a._rgba=n._rgba,!1):t}),r.length?("0,0,0,0"===r.join()&&e.extend(r,s.transparent),a):s[i]}function r(e,t,i){return i=(i+1)%1,1>6*i?e+6*(t-e)*i:1>2*i?t:2>3*i?e+6*(t-e)*(2/3-i):e}var s,n="backgroundColor borderBottomColor borderLeftColor borderRightColor borderTopColor color columnRuleColor outlineColor textDecorationColor textEmphasisColor",o=/^([\-+])=\s*(\d+\.?\d*)/,d=[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,parse:function(e){return[e[1],e[2],e[3],e[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,parse:function(e){return[2.55*e[1],2.55*e[2],2.55*e[3],e[4]]}},{re:/#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})/,parse:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]}},{re:/#([a-f0-9])([a-f0-9])([a-f0-9])/,parse:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]}},{re:/hsla?\(\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,space:"hsla",parse:function(e){return[e[1],e[2]/100,e[3]/100,e[4]]}}],u=e.Color=function(t,i,a,r){return new e.Color.fn.parse(t,i,a,r)},h={rgba:{props:{red:{idx:0,type:"byte"},green:{idx:1,type:"byte"},blue:{idx:2,type:"byte"}}},hsla:{props:{hue:{idx:0,type:"degrees"},saturation:{idx:1,type:"percent"},lightness:{idx:2,type:"percent"}}}},l={"byte":{floor:!0,max:255},percent:{max:1},degrees:{mod:360,floor:!0}},c=u.support={},m=e("<p>")[0],p=e.each;m.style.cssText="background-color:rgba(1,1,1,.5)",c.rgba=m.style.backgroundColor.indexOf("rgba")>-1,p(h,function(e,t){t.cache="_"+e,t.props.alpha={idx:3,type:"percent",def:1}}),u.fn=e.extend(u.prototype,{parse:function(r,n,o,d){if(r===t)return this._rgba=[null,null,null,null],this;(r.jquery||r.nodeType)&&(r=e(r).css(n),n=t);var l=this,c=e.type(r),m=this._rgba=[];return n!==t&&(r=[r,n,o,d],c="array"),"string"===c?this.parse(a(r)||s._default):"array"===c?(p(h.rgba.props,function(e,t){m[t.idx]=i(r[t.idx],t)}),this):"object"===c?(r instanceof u?p(h,function(e,t){r[t.cache]&&(l[t.cache]=r[t.cache].slice())}):p(h,function(t,a){var s=a.cache;p(a.props,function(e,t){if(!l[s]&&a.to){if("alpha"===e||null==r[e])return;l[s]=a.to(l._rgba)}l[s][t.idx]=i(r[e],t,!0)}),l[s]&&0>e.inArray(null,l[s].slice(0,3))&&(l[s][3]=1,a.from&&(l._rgba=a.from(l[s])))}),this):t},is:function(e){var i=u(e),a=!0,r=this;return p(h,function(e,s){var n,o=i[s.cache];return o&&(n=r[s.cache]||s.to&&s.to(r._rgba)||[],p(s.props,function(e,i){return null!=o[i.idx]?a=o[i.idx]===n[i.idx]:t})),a}),a},_space:function(){var e=[],t=this;return p(h,function(i,a){t[a.cache]&&e.push(i)}),e.pop()},transition:function(e,t){var a=u(e),r=a._space(),s=h[r],n=0===this.alpha()?u("transparent"):this,o=n[s.cache]||s.to(n._rgba),d=o.slice();return a=a[s.cache],p(s.props,function(e,r){var s=r.idx,n=o[s],u=a[s],h=l[r.type]||{};null!==u&&(null===n?d[s]=u:(h.mod&&(u-n>h.mod/2?n+=h.mod:n-u>h.mod/2&&(n-=h.mod)),d[s]=i((u-n)*t+n,r)))}),this[r](d)},blend:function(t){if(1===this._rgba[3])return this;var i=this._rgba.slice(),a=i.pop(),r=u(t)._rgba;return u(e.map(i,function(e,t){return(1-a)*r[t]+a*e}))},toRgbaString:function(){var t="rgba(",i=e.map(this._rgba,function(e,t){return null==e?t>2?1:0:e});return 1===i[3]&&(i.pop(),t="rgb("),t+i.join()+")"},toHslaString:function(){var t="hsla(",i=e.map(this.hsla(),function(e,t){return null==e&&(e=t>2?1:0),t&&3>t&&(e=Math.round(100*e)+"%"),e});return 1===i[3]&&(i.pop(),t="hsl("),t+i.join()+")"},toHexString:function(t){var i=this._rgba.slice(),a=i.pop();return t&&i.push(~~(255*a)),"#"+e.map(i,function(e){return e=(e||0).toString(16),1===e.length?"0"+e:e}).join("")},toString:function(){return 0===this._rgba[3]?"transparent":this.toRgbaString()}}),u.fn.parse.prototype=u.fn,h.hsla.to=function(e){if(null==e[0]||null==e[1]||null==e[2])return[null,null,null,e[3]];var t,i,a=e[0]/255,r=e[1]/255,s=e[2]/255,n=e[3],o=Math.max(a,r,s),d=Math.min(a,r,s),u=o-d,h=o+d,l=.5*h;return t=d===o?0:a===o?60*(r-s)/u+360:r===o?60*(s-a)/u+120:60*(a-r)/u+240,i=0===u?0:.5>=l?u/h:u/(2-h),[Math.round(t)%360,i,l,null==n?1:n]},h.hsla.from=function(e){if(null==e[0]||null==e[1]||null==e[2])return[null,null,null,e[3]];var t=e[0]/360,i=e[1],a=e[2],s=e[3],n=.5>=a?a*(1+i):a+i-a*i,o=2*a-n;return[Math.round(255*r(o,n,t+1/3)),Math.round(255*r(o,n,t)),Math.round(255*r(o,n,t-1/3)),s]},p(h,function(a,r){var s=r.props,n=r.cache,d=r.to,h=r.from;u.fn[a]=function(a){if(d&&!this[n]&&(this[n]=d(this._rgba)),a===t)return this[n].slice();var r,o=e.type(a),l="array"===o||"object"===o?a:arguments,c=this[n].slice();return p(s,function(e,t){var a=l["object"===o?e:t.idx];null==a&&(a=c[t.idx]),c[t.idx]=i(a,t)}),h?(r=u(h(c)),r[n]=c,r):u(c)},p(s,function(t,i){u.fn[t]||(u.fn[t]=function(r){var s,n=e.type(r),d="alpha"===t?this._hsla?"hsla":"rgba":a,u=this[d](),h=u[i.idx];return"undefined"===n?h:("function"===n&&(r=r.call(this,h),n=e.type(r)),null==r&&i.empty?this:("string"===n&&(s=o.exec(r),s&&(r=h+parseFloat(s[2])*("+"===s[1]?1:-1))),u[i.idx]=r,this[d](u)))})})}),u.hook=function(t){var i=t.split(" ");p(i,function(t,i){e.cssHooks[i]={set:function(t,r){var s,n,o="";if("transparent"!==r&&("string"!==e.type(r)||(s=a(r)))){if(r=u(s||r),!c.rgba&&1!==r._rgba[3]){for(n="backgroundColor"===i?t.parentNode:t;(""===o||"transparent"===o)&&n&&n.style;)try{o=e.css(n,"backgroundColor"),n=n.parentNode}catch(d){}r=r.blend(o&&"transparent"!==o?o:"_default")}r=r.toRgbaString()}try{t.style[i]=r}catch(d){}}},e.fx.step[i]=function(t){t.colorInit||(t.start=u(t.elem,i),t.end=u(t.end),t.colorInit=!0),e.cssHooks[i].set(t.elem,t.start.transition(t.end,t.pos))}})},u.hook(n),e.cssHooks.borderColor={expand:function(e){var t={};return p(["Top","Right","Bottom","Left"],function(i,a){t["border"+a+"Color"]=e}),t}},s=e.Color.names={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00",transparent:[null,null,null,0],_default:"#ffffff"}}(jQuery),function(){function i(t){var i,a,r=t.ownerDocument.defaultView?t.ownerDocument.defaultView.getComputedStyle(t,null):t.currentStyle,s={};if(r&&r.length&&r[0]&&r[r[0]])for(a=r.length;a--;)i=r[a],"string"==typeof r[i]&&(s[e.camelCase(i)]=r[i]);else for(i in r)"string"==typeof r[i]&&(s[i]=r[i]);return s}function a(t,i){var a,r,n={};for(a in i)r=i[a],t[a]!==r&&(s[a]||(e.fx.step[a]||!isNaN(parseFloat(r)))&&(n[a]=r));return n}var r=["add","remove","toggle"],s={border:1,borderBottom:1,borderColor:1,borderLeft:1,borderRight:1,borderTop:1,borderWidth:1,margin:1,padding:1};e.each(["borderLeftStyle","borderRightStyle","borderBottomStyle","borderTopStyle"],function(t,i){e.fx.step[i]=function(e){("none"!==e.end&&!e.setAttr||1===e.pos&&!e.setAttr)&&(jQuery.style(e.elem,i,e.end),e.setAttr=!0)}}),e.fn.addBack||(e.fn.addBack=function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}),e.effects.animateClass=function(t,s,n,o){var d=e.speed(s,n,o);return this.queue(function(){var s,n=e(this),o=n.attr("class")||"",u=d.children?n.find("*").addBack():n;u=u.map(function(){var t=e(this);return{el:t,start:i(this)}}),s=function(){e.each(r,function(e,i){t[i]&&n[i+"Class"](t[i])})},s(),u=u.map(function(){return this.end=i(this.el[0]),this.diff=a(this.start,this.end),this}),n.attr("class",o),u=u.map(function(){var t=this,i=e.Deferred(),a=e.extend({},d,{queue:!1,complete:function(){i.resolve(t)}});return this.el.animate(this.diff,a),i.promise()}),e.when.apply(e,u.get()).done(function(){s(),e.each(arguments,function(){var t=this.el;e.each(this.diff,function(e){t.css(e,"")})}),d.complete.call(n[0])})})},e.fn.extend({addClass:function(t){return function(i,a,r,s){return a?e.effects.animateClass.call(this,{add:i},a,r,s):t.apply(this,arguments)}}(e.fn.addClass),removeClass:function(t){return function(i,a,r,s){return arguments.length>1?e.effects.animateClass.call(this,{remove:i},a,r,s):t.apply(this,arguments)}}(e.fn.removeClass),toggleClass:function(i){return function(a,r,s,n,o){return"boolean"==typeof r||r===t?s?e.effects.animateClass.call(this,r?{add:a}:{remove:a},s,n,o):i.apply(this,arguments):e.effects.animateClass.call(this,{toggle:a},r,s,n)}}(e.fn.toggleClass),switchClass:function(t,i,a,r,s){return e.effects.animateClass.call(this,{add:i,remove:t},a,r,s)}})}(),function(){function a(t,i,a,r){return e.isPlainObject(t)&&(i=t,t=t.effect),t={effect:t},null==i&&(i={}),e.isFunction(i)&&(r=i,a=null,i={}),("number"==typeof i||e.fx.speeds[i])&&(r=a,a=i,i={}),e.isFunction(a)&&(r=a,a=null),i&&e.extend(t,i),a=a||i.duration,t.duration=e.fx.off?0:"number"==typeof a?a:a in e.fx.speeds?e.fx.speeds[a]:e.fx.speeds._default,t.complete=r||i.complete,t}function r(t){return!t||"number"==typeof t||e.fx.speeds[t]?!0:"string"!=typeof t||e.effects.effect[t]?e.isFunction(t)?!0:"object"!=typeof t||t.effect?!1:!0:!0}e.extend(e.effects,{version:"1.10.3",save:function(e,t){for(var a=0;t.length>a;a++)null!==t[a]&&e.data(i+t[a],e[0].style[t[a]])},restore:function(e,a){var r,s;for(s=0;a.length>s;s++)null!==a[s]&&(r=e.data(i+a[s]),r===t&&(r=""),e.css(a[s],r))},setMode:function(e,t){return"toggle"===t&&(t=e.is(":hidden")?"show":"hide"),t},getBaseline:function(e,t){var i,a;switch(e[0]){case"top":i=0;break;case"middle":i=.5;break;case"bottom":i=1;break;default:i=e[0]/t.height}switch(e[1]){case"left":a=0;break;case"center":a=.5;break;case"right":a=1;break;default:a=e[1]/t.width}return{x:a,y:i}},createWrapper:function(t){if(t.parent().is(".ui-effects-wrapper"))return t.parent();var i={width:t.outerWidth(!0),height:t.outerHeight(!0),"float":t.css("float")},a=e("<div></div>").addClass("ui-effects-wrapper").css({fontSize:"100%",background:"transparent",border:"none",margin:0,padding:0}),r={width:t.width(),height:t.height()},s=document.activeElement;try{s.id}catch(n){s=document.body}return t.wrap(a),(t[0]===s||e.contains(t[0],s))&&e(s).focus(),a=t.parent(),"static"===t.css("position")?(a.css({position:"relative"}),t.css({position:"relative"})):(e.extend(i,{position:t.css("position"),zIndex:t.css("z-index")}),e.each(["top","left","bottom","right"],function(e,a){i[a]=t.css(a),isNaN(parseInt(i[a],10))&&(i[a]="auto")}),t.css({position:"relative",top:0,left:0,right:"auto",bottom:"auto"})),t.css(r),a.css(i).show()},removeWrapper:function(t){var i=document.activeElement;return t.parent().is(".ui-effects-wrapper")&&(t.parent().replaceWith(t),(t[0]===i||e.contains(t[0],i))&&e(i).focus()),t},setTransition:function(t,i,a,r){return r=r||{},e.each(i,function(e,i){var s=t.cssUnit(i);s[0]>0&&(r[i]=s[0]*a+s[1])}),r}}),e.fn.extend({effect:function(){function t(t){function a(){e.isFunction(s)&&s.call(r[0]),e.isFunction(t)&&t()}var r=e(this),s=i.complete,o=i.mode;(r.is(":hidden")?"hide"===o:"show"===o)?(r[o](),a()):n.call(r[0],i,a)}var i=a.apply(this,arguments),r=i.mode,s=i.queue,n=e.effects.effect[i.effect];return e.fx.off||!n?r?this[r](i.duration,i.complete):this.each(function(){i.complete&&i.complete.call(this)}):s===!1?this.each(t):this.queue(s||"fx",t)},show:function(e){return function(t){if(r(t))return e.apply(this,arguments);var i=a.apply(this,arguments);return i.mode="show",this.effect.call(this,i)}}(e.fn.show),hide:function(e){return function(t){if(r(t))return e.apply(this,arguments);var i=a.apply(this,arguments);return i.mode="hide",this.effect.call(this,i)}}(e.fn.hide),toggle:function(e){return function(t){if(r(t)||"boolean"==typeof t)return e.apply(this,arguments);var i=a.apply(this,arguments);return i.mode="toggle",this.effect.call(this,i)}}(e.fn.toggle),cssUnit:function(t){var i=this.css(t),a=[];return e.each(["em","px","%","pt"],function(e,t){i.indexOf(t)>0&&(a=[parseFloat(i),t])}),a}})}(),function(){var t={};e.each(["Quad","Cubic","Quart","Quint","Expo"],function(e,i){t[i]=function(t){return Math.pow(t,e+2)}}),e.extend(t,{Sine:function(e){return 1-Math.cos(e*Math.PI/2)},Circ:function(e){return 1-Math.sqrt(1-e*e)},Elastic:function(e){return 0===e||1===e?e:-Math.pow(2,8*(e-1))*Math.sin((80*(e-1)-7.5)*Math.PI/15)},Back:function(e){return e*e*(3*e-2)},Bounce:function(e){for(var t,i=4;((t=Math.pow(2,--i))-1)/11>e;);return 1/Math.pow(4,3-i)-7.5625*Math.pow((3*t-2)/22-e,2)}}),e.each(t,function(t,i){e.easing["easeIn"+t]=i,e.easing["easeOut"+t]=function(e){return 1-i(1-e)},e.easing["easeInOut"+t]=function(e){return.5>e?i(2*e)/2:1-i(-2*e+2)/2}})}()})(jQuery);(function(e){e.effects.effect.clip=function(t,a){var i,r,s,n=e(this),o=["position","top","bottom","left","right","height","width"],d=e.effects.setMode(n,t.mode||"hide"),l="show"===d,u=t.direction||"vertical",h="vertical"===u,c=h?"height":"width",m=h?"top":"left",p={};e.effects.save(n,o),n.show(),i=e.effects.createWrapper(n).css({overflow:"hidden"}),r="IMG"===n[0].tagName?i:n,s=r[c](),l&&(r.css(c,0),r.css(m,s/2)),p[c]=l?s:0,p[m]=l?0:s/2,r.animate(p,{queue:!1,duration:t.duration,easing:t.easing,complete:function(){l||n.hide(),e.effects.restore(n,o),e.effects.removeWrapper(n),a()}})}})(jQuery);
		`

		# Generate unique ids
		ps.uid = (->
		  id = 0
		  ->
		    id = 0  if arguments[0] is 0
		    id++
		)()

	
		## Embed
		ps.links = ->
			$("a[href*='#{ps.DOMAIN}']")

		ps.parsePathname = (pathname) ->
			result = {}
			if pathname.indexOf('/space/') > -1
				result.type = 'space'
			else
				result.type = 'user'
			paths = pathname.split("/")
			result.id = paths[paths.length - 1]
			result

		ps.embedableLinks = ->
			# TODO: check that the link can be embedded
			# Do this with an Ajax API call that returns the embeddable uri
			result = []
			for link in ps.links()
				$el = $(link)
				pathname = ps.parsePathname(link.pathname)
				embedId = ps.uid()
				uri = "http://#{ps.DOMAIN}/embed/#{pathname.type}/link/#{pathname.id}?eid=#{embedId}&text=#{$el.text()}&ff=#{$el.css('font-family')}&fs=#{$el.css('font-size')}&fw=#{$el.css('font-weight')}&lh=#{$el.css('line-height')}&ls=#{$el.css('letter-spacing')}&ws=#{$el.css('word-spacing')}&co=#{$el.css('color')}"
				result.push
					el: $el
					uri: uri
					eid: embedId
					id: pathname.id
					type: pathname.type
			result

		ps.embedLinks = ->
			for linkObj in ps.embedableLinks()
				$newEl = $ """
					<span class="ps-embed-wrap" style="width: #{linkObj.el.outerWidth()}px; height: #{linkObj.el.outerHeight()}px; display: inline-block; vertical-align: top;">
						<iframe class="ps-embed ps-embed-link" src="#{linkObj.uri}" frameborder="0" border="0" cellspacing="0" style="border-style: none;width: #{linkObj.el.outerWidth()}px; height: #{linkObj.el.outerHeight()}px;" scrolling="no"></iframe>
					</span>
				"""
				linkObj.el.replaceWith $newEl
				ps.embededLinks[linkObj.eid] = 
					el: $newEl
					id: linkObj.id
					type: linkObj.type
			ps.embededLinks


		## Expand
		ps.clickLink = (id) ->
			ps.contractLink(ps.currentLinkId)
			if ps.currentLinkId == id
				ps.currentLinkId = null
			else
				ps.expandLink(id)
			
		ps.expandLink = (id) ->
			ps.currentLinkId = id
			$expandEl = ps.findOrCreateExpandedLink(id)				
			$expandEl.show 'clip', {}, 200
			$expandEl

		ps.contractAllLinks = ->
			for id of ps.expandedLinks
				ps.contractLink(id)
			ps.currentLinkId = null

		ps.contractLink = (id) ->
			if id then ps.expandedLinks[id]?.hide 'clip', {}, 200

		# TODO: is this performant?
		$('body').on 'click', ->
			if ps.currentLinkId
				ps.contractLink(ps.currentLinkId)
				ps.currentLinkId = null

		ps.findOrCreateExpandedLink = (id) ->
			$expandEl = ps.expandedLinks[id]
			unless $expandEl?
				linkObj = ps.embededLinks[id]
				width = 300
				height = 400
				uri = "http://#{ps.DOMAIN}/embed/#{linkObj.type}/expanded/#{linkObj.id}"

				$expandEl = $ """
					<div class="ps-embed-wrap" style="width:#{width}px; height:#{height}px; display:none; position:absolute; background:white; border-radius:3px; border:1px solid #ccc; box-shadow:rgba(0, 0, 0, 0.08) 1px 1px 4px 2px; margin:10px;">
						 <iframe class="ps-embed ps-embed-space" src="#{uri}" frameborder="0" border="0" cellspacing="0" style="border-style: none;width: #{width}px; height: #{height}px;" scrolling="yes"></iframe>
					</div>
				"""
				
				ps.expandedLinks[id] = $expandEl
				$("body").append $expandEl
				$expandEl.position
					my: "left+#{linkObj.el.width()/2 + 3} center"
					at: 'center'
					of: linkObj.el
					collision: 'flipfit'
			$expandEl


		## PostMessage
		ps.receiveMessage = (event) ->
			# For security only execute if called from the correct origin
			if event.origin.indexOf(ps.DOMAIN) > -1
				data = event.data.split("_")
				switch data[0]
					when 'psClickLink' then ps.clickLink(data[1])

		window.addEventListener("message", ps.receiveMessage, false)


		## Initialize the widgets
		$(document).ready () ->
			ps.embedLinks()


		## Return the ps object
		ps
	)()


	## Change namespace to ps if available
	unless root.ps?
		root.ps = root.positivespaceWidgetGlobalNamespace
		delete root.positivespaceWidgetGlobalNamespace